BootStrap: localimage
From: basicimage.simg

%labels
    author "leonardo.baroncelli@inaf.it, luca.babboni2@studio.unibo.it"
    version "1.0.0"

%post

    export DBPWD=$(cat /tmp/dbpassword.txt)
    if [ -z "$DBPWD" ]; then
        echo "\$DBPWD is not set. Aborting build."
        exit 1
    fi
    export CLIENTSECRET=$(cat /tmp/kafkaclientsecret.txt)
    if [ -z "$CLIENTSECRET" ]; then
        echo "\$CLIENTSECRET is not set. Aborting build."
        exit 1
    fi

    #create and activate virtual environment
    python3 -m venv /opt/venv/kafka
    source /opt/venv/kafka/bin/activate

    #installing kafka receiver
    cd /opt && rm -rf rta-transient-receiver-kafka/  
    git clone --recurse-submodules https://github.com/ASTRO-EDU/rta-transient-receiver-kafka.git
    cd rta-transient-receiver-kafka/
    echo -e "{\n\"_section_1\": \"database connection information\",\n\"Database_user\": \"rt\",\n\"Database_password\" : \"$DBPWD\",\n\"Database_host\":\"127.0.0.1\",\n\"Database_port\":\"60306\",\n\"Database_name\":\"kafka_test\",\n\"_section_2\": \"sender_email_information\",\n\"packet_with_email_notification\": [\"150\", \"151\", \"152\", \"163\", \"158\", \"169\", \"173\", \"174\"],\n\"sender_email\": \"alert.agile@inaf.it\",\n\"sender_email_password\": \"agile4ever@2016\",\n\"email_recivers\" : [\"luca.babboni2@studio.unibo.it\"],\n\"important_email_subject\" : [\"IMPORTAT : \"]\n}" > rta-transient-receiver/voeventhandler/config/config.json
    echo -e "{\n\"_section_3\": \"kafka cliens credentials\",\n\"client_id\":\"6kna0l5ekavqbpa7emu8sinot9\",\n\"client_secret\":\"$CLIENTSECRET\"\n}" > kafkareceiver/config/config.json
    pip install -r rta-transient-receiver/requirements.txt
    pip install -r requirements.txt
    pip install -e rta-transient-receiver/
    pip install -e .

    %runscript
    source /opt/venv/kafka/bin/activate
    #cd opt/rta-transient-receiver-kafka/
    #/opt/venv/kafka/bin/python3 kafkareceiver/kafkareceiver.py

    %help
    # This help section is displayed via "singularity help <instance>"
    # and should describe the features of the container
    echo "This is a container for the kafka receiver production image. To build this repipe create a file called dbpassword.txt with the password for the database and put it in the same folder of the Singularity file."
